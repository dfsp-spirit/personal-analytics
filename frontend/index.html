<!DOCTYPE html>
<html>
<head>
    <title>ts // Personal Analytics</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">Personal Analytics</h1>
            <p class="subtitle">Track your daily health and habits</p>
            <div class="nav-links">
                <a href="stats.html">To Statistics page</a>
            </div>
            <h2 class="date-display"></h2>
            <div id="entry-status" class="entry-status"></div>
        </header>

        <div class="date-selector">
            <label for="entry-date">Entry Date:</label>
            <input type="date" id="entry-date" name="entry-date">
            <div class="date-navigation">
                <button type="button" id="prev-day">◀</button>
                <button type="button" id="next-day">▶</button>
                <button type="button" id="today-btn">Today</button>
            </div>
        </div>

        <form id="healthForm"></form>
    </div>

    <script src="settings.js"></script>
    <script src="user-manager.js"></script>
    <script src="common.js"></script>
    <script src="form-config.js"></script>
    <script src="form-generator.js"></script>
    <script>
        // Generate the entire form
        const form = document.getElementById('healthForm');

        // Set max date to today
        function initializeDatePicker() {
            const dateInput = document.getElementById('entry-date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('max', today);
        }




        Object.entries(FORM_CONFIG).forEach(([fieldName, config]) => {
            form.appendChild(generateFormField(fieldName, config));
        });

        // Add submit button
        const submitBtn = document.createElement('button');
        submitBtn.type = 'submit';
        submitBtn.textContent = 'Save Entry';
        form.appendChild(submitBtn);

        // Track unsaved changes to warn on date change
        form.addEventListener('change', function() {
            hasUnsavedChanges = true;
        });

        // Date management
        let currentDate = new Date();
        let hasUnsavedChanges = false;
        let currentEntryExists = false; // Track if entry exists in DB for current date

        // Add this function to update the status display
        function updateEntryStatus(exists) {
            currentEntryExists = exists;
            const statusElement = document.getElementById('entry-status');
            const submitBtn = document.querySelector('button[type="submit"]');

            if (exists) {
                statusElement.innerHTML = '<span class="status-badge status-exists">✓ Entry exists</span>';
                submitBtn.textContent = 'Update Entry';
                submitBtn.className = 'btn-update';
            } else {
                statusElement.innerHTML = '<span class="status-badge status-new">+ New entry</span>';
                submitBtn.textContent = 'Save Entry';
                submitBtn.className = 'btn-save';
            }
        }

        function updateDateDisplay() {
            const dateInput = document.getElementById('entry-date');
            dateInput.value = currentDate.toISOString().split('T')[0];

            // Disable next day button if it's today or in the future
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextDayBtn = document.getElementById('next-day');
            nextDayBtn.disabled = currentDate >= today;

            // Also disable the today button if already today
            const todayBtn = document.getElementById('today-btn');
            todayBtn.disabled = isToday(currentDate);

            // Update form title
            const dateDisplay = document.querySelector('h2.date-display');

            // Calculate days ago
            const todayMidnight = new Date();
            todayMidnight.setHours(0, 0, 0, 0);

            const currentDateMidnight = new Date(currentDate);
            currentDateMidnight.setHours(0, 0, 0, 0);

            const timeDiff = todayMidnight.getTime() - currentDateMidnight.getTime();
            const daysAgo = Math.floor(timeDiff / (1000 * 3600 * 24));


            if (isToday(currentDate)) {
                dateDisplay.textContent = 'Data for: Today';
            } else {
                const formattedDate = currentDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Handle "days ago" text
                let daysAgoText = '';
                if (daysAgo === 1) {
                    daysAgoText = '-- 1 day ago';
                } else if (daysAgo > 1) {
                    daysAgoText = `-- ${daysAgo} days ago`;
                } else if (daysAgo < 0) {
                    // Future date
                    const futureDays = Math.abs(daysAgo);
                    if (futureDays === 1) {
                        daysAgoText = '-- 1 day from now';
                    } else {
                        daysAgoText = `-- ${futureDays} days from now`;
                    }
                }

                    dateDisplay.textContent = `Data for: ${formattedDate} ${daysAgoText}`;
         }
            // Load existing data for selected date
            loadEntryForDate(currentDate.toISOString().split('T')[0]);

        }

function changeDate(days) {
    if (hasUnsavedChanges) {
        if (!confirm('You have unsaved changes. Switch date anyway?')) {
            return;
        }
    }

    FormUtils.setFormDefaults(); // Prevent carrying over local, unsaved changes to new date.
    currentDate.setDate(currentDate.getDate() + days);
    updateDateDisplay();
    hasUnsavedChanges = false;
}

function setToToday() {
    currentDate = new Date();
    updateDateDisplay();
}

function isToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
}




// Event listeners for date navigation
document.getElementById('prev-day').addEventListener('click', () => changeDate(-1));
document.getElementById('next-day').addEventListener('click', () => changeDate(1));
document.getElementById('today-btn').addEventListener('click', setToToday);

// Date input change
document.getElementById('entry-date').addEventListener('change', function() {
    currentDate = new Date(this.value);
    updateDateDisplay();
});

// Update the form submission to reset status after successful save
form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    const formData = FormUtils.collectFormData();
    formData.date = currentDate.toISOString().split('T')[0]; // Use selected date

    try {
        submitBtn.textContent = 'Saving...';
        submitBtn.disabled = true;

        const response = await fetch(`${SETTINGS.API_BASE_URL}/entries/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to save data');
        }

        const result = await response.json();
        const operation = response.headers.get('X-Operation');
        console.log('X-Operation from header:', operation);
        const message = operation === 'created' ?
            'New entry created!' : 'Entry updated!';

        console.log(message, result);
        alert(message);
        hasUnsavedChanges = false;

        // Update status after successful save
        updateEntryStatus(true); // Now an entry exists for this date

    } catch (error) {
        console.error('Error saving data to backend at API BASE URL ' + `${SETTINGS.API_BASE_URL}` + ' :', error);
        console.log('Falling back to localStorage...');
        saveToStorage(formData);
        showBackendErrorBanner('Saved to local storage (backend API error: ' + error.message + ')');
        updateEntryStatus(true);
    } finally {
        submitBtn.textContent = currentEntryExists ? 'Update Entry' : 'Save Entry';
        submitBtn.disabled = false;
    }
});

// Update the loadEntryForDate function to set the status
async function loadEntryForDate(date) {
    try {
        const response = await fetch(`${SETTINGS.API_BASE_URL}/entries/?start_date=${date}&end_date=${date}`);

        if (response.ok) {
            const entries = await response.json();
            if (entries.length > 0) {
                // Auto-load the existing entry
                FormUtils.loadDataIntoForm(entries[0]);
                updateSliderDisplays();
                updateEntryStatus(true); // Entry exists
                console.log(`Loaded existing entry for ${date}`);
            } else {
                // Clear form if no entry exists
                FormUtils.setFormDefaults();
                updateSliderDisplays();
                updateEntryStatus(false); // No entry exists
                console.log(`No existing entry found for ${date}. Presenting empty form.`);
            }
        }
    } catch (error) {
        console.log('API unavailable at API BASE URL ' + `${SETTINGS.API_BASE_URL}` + ', checking localStorage...');
        // Fallback to localStorage
        showBackendErrorBanner('Failed to load data from backend.');
        const existingData = JSON.parse(localStorage.getItem('healthData') || '[]');
        const existingEntry = existingData.find(entry => entry.date === date);

        if (existingEntry) {
            FormUtils.loadDataIntoForm(existingEntry);
            updateSliderDisplays();
            updateEntryStatus(true);
        } else {
            FormUtils.setFormDefaults();
            updateSliderDisplays();
            updateEntryStatus(false);
        }
    }
}



                // Set defaults when page loads

                window.addEventListener('load', async function() {
    initializeDatePicker();
    FormUtils.setFormDefaults();
    updateSliderDisplays();
    updateDateDisplay(); // This will handle loading existing data
});

        function saveToStorage(entry) {
            const existingData = JSON.parse(localStorage.getItem('healthData') || '[]');

            // Check if an entry for today already exists
            const todayIndex = existingData.findIndex(e => e.date === entry.date);
            if (todayIndex !== -1) {
                // Update existing entry
                existingData[todayIndex] = entry;
            } else {
                // Add new entry
                existingData.push(entry);
            }

            localStorage.setItem('healthData', JSON.stringify(existingData));
        }

    </script>
    <footer class="app-footer">
        <div class="footer-content">
            <span>User ID: <span id="footer-userid">loading...</span></span>
            <span>Backend URL: <span id="footer-backend-url">loading...</span></span>
        </div>
    </footer>

</body>
</html>