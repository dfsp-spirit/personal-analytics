<!DOCTYPE html>
<html>
<head>
    <title>ts // Personal Analytics</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">Personal Analytics</h1>
            <p class="subtitle">Track your daily health and habits</p>
            <h2 class="date-display"></h2>
        </header>

        <div class="date-selector">
            <label for="entry-date">Entry Date:</label>
            <input type="date" id="entry-date" name="entry-date">
            <div class="date-navigation">
                <button type="button" id="prev-day">â—€</button>
                <button type="button" id="next-day">â–¶</button>
                <button type="button" id="today-btn">Today</button>
            </div>
        </div>

        <form id="healthForm"></form>
    </div>

    <script src="form-config.js"></script>
    <script src="form-generator.js"></script>
    <script>
        // Generate the entire form
        const form = document.getElementById('healthForm');

        // Set max date to today
        function initializeDatePicker() {
            const dateInput = document.getElementById('entry-date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('max', today);
        }




        Object.entries(FORM_CONFIG).forEach(([fieldName, config]) => {
            form.appendChild(generateFormField(fieldName, config));
        });

        // Add submit button
        const submitBtn = document.createElement('button');
        submitBtn.type = 'submit';
        submitBtn.textContent = 'Save Entry';
        form.appendChild(submitBtn);

        // Date management
        let currentDate = new Date();

        function updateDateDisplay() {
            const dateInput = document.getElementById('entry-date');
            dateInput.value = currentDate.toISOString().split('T')[0];

            // Disable next day button if it's today or in the future
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextDayBtn = document.getElementById('next-day');
            nextDayBtn.disabled = currentDate >= today;

            // Update form title
            const dateDisplay = document.querySelector('h2.date-display');
            if (isToday(currentDate)) {
                dateDisplay.textContent = 'Data for: Today';
            } else {
                const formattedDate = currentDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                dateDisplay.textContent = `Data for: ${formattedDate}`;
            }

            // Load existing data for selected date
            loadEntryForDate(currentDate.toISOString().split('T')[0]);
        }

function changeDate(days) {
    currentDate.setDate(currentDate.getDate() + days);
    updateDateDisplay();
}

function setToToday() {
    currentDate = new Date();
    updateDateDisplay();
}

function isToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
}

// Update form submission to use selected date
form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    const formData = FormUtils.collectFormData();
    formData.date = currentDate.toISOString().split('T')[0]; // Use selected date

    try {
        submitBtn.textContent = 'Saving...';
        submitBtn.disabled = true;

        const response = await fetch(`${API_BASE_URL}/entries/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to save data');
        }

        const result = await response.json();
        const operation = response.headers.get('X-Operation');
        const message = operation === 'created' ?
            'ðŸŽ‰ New entry created!' : 'âœï¸ Entry updated!';

        console.log(message, result);
        alert(message);

    } catch (error) {
        console.error('Error saving data:', error);
        console.log('Falling back to localStorage...');
        saveToStorage(formData);
        alert('Saved to local storage (API unavailable)');

    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

// Update loadEntryForDate function
async function loadEntryForDate(date) {
    try {
        const response = await fetch(`${API_BASE_URL}/entries/?start_date=${date}&end_date=${date}`);

        if (response.ok) {
            const entries = await response.json();
            if (entries.length > 0) {
                // Auto-load the existing entry
                FormUtils.loadDataIntoForm(entries[0]);
                updateSliderDisplays();
                console.log(`Loaded existing entry for ${date}`);
            } else {
                // Clear form if no entry exists
                FormUtils.setFormDefaults();
                updateSliderDisplays();
                console.log(`No existing entry found for ${date}. Presenting empty form.`);
            }
        }
    } catch (error) {
        console.log('API unavailable, checking localStorage...');
        // Fallback to localStorage
        const existingData = JSON.parse(localStorage.getItem('healthData') || '[]');
        const existingEntry = existingData.find(entry => entry.date === date);

        if (existingEntry) {
            FormUtils.loadDataIntoForm(existingEntry);
            updateSliderDisplays();
        } else {
            FormUtils.setFormDefaults();
            updateSliderDisplays();
        }
    }
}

// Event listeners for date navigation
document.getElementById('prev-day').addEventListener('click', () => changeDate(-1));
document.getElementById('next-day').addEventListener('click', () => changeDate(1));
document.getElementById('today-btn').addEventListener('click', setToToday);

// Date input change
document.getElementById('entry-date').addEventListener('change', function() {
    currentDate = new Date(this.value);
    updateDateDisplay();
});



                // Set defaults when page loads

                window.addEventListener('load', async function() {
    initializeDatePicker();
    FormUtils.setFormDefaults();
    updateSliderDisplays();
    updateDateDisplay(); // This will handle loading existing data
});

        function saveToStorage(entry) {
            const existingData = JSON.parse(localStorage.getItem('healthData') || '[]');

            // Check if an entry for today already exists
            const todayIndex = existingData.findIndex(e => e.date === entry.date);
            if (todayIndex !== -1) {
                // Update existing entry
                existingData[todayIndex] = entry;
            } else {
                // Add new entry
                existingData.push(entry);
            }

            localStorage.setItem('healthData', JSON.stringify(existingData));
        }

    </script>
</body>
</html>