<!DOCTYPE html>
<html>
<head>
    <title>ts // Personal Analytics - Statistics</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:,">
    <script src="//cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .metric-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .lagged-results p {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .correlation-value.positive {
            color: #28a745;
            font-weight: bold;
        }
        .correlation-value.negative {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="stats-container">
        <header>
            <h1>Personal Analytics - Statistics</h1>
            <div class="nav-links">
                <a href="index.html">‚Üê Back to Daily Entry</a>
            </div>
        </header>

        <div class="controls">
            <label for="days-range">Time Range:</label>
            <select id="days-range">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 3 months</option>
                <option value="365">Last year</option>
            </select>

            <div class="metric-selector">
                <div class="metric-checkbox">
                    <input type="checkbox" id="mood-check" checked>
                    <label for="mood-check">Mood</label>
                </div>
                <div class="metric-checkbox">
                    <input type="checkbox" id="pain-check" checked>
                    <label for="pain-check">Pain</label>
                </div>
                <div class="metric-checkbox">
                    <input type="checkbox" id="sexual_wellbeing-check" checked>
                    <label for="sexual_wellbeing-check">Sexual Wellbeing</label>
                </div>
                <div class="metric-checkbox">
                    <input type="checkbox" id="energy-check">
                    <label for="energy-check">Energy</label>
                </div>
                <div class="metric-checkbox">
                    <input type="checkbox" id="sleep_quality-check">
                    <label for="sleep_quality-check">Sleep Quality</label>
                </div>
            </div>

            <button id="update-chart">Update Chart</button>
        </div>

        <div class="chart-container">
            <canvas id="metricsChart"></canvas>
        </div>

        <!-- Summary Statistics -->
        <div class="stats-section">
            <h2>Summary Statistics</h2>
            <div id="summary-stats" class="stats-grid"></div>
        </div>

        <!-- Weekday Averages -->
        <div class="stats-section">
            <h2>Average Metrics by Weekday</h2>
            <div class="chart-container">
                <canvas id="weekdayChart"></canvas>
            </div>
        </div>

        <!-- Correlation Matrix -->
        <div class="stats-section">
            <h2>Metric Correlations</h2>
            <div id="correlation-matrix" class="correlation-grid"></div>
        </div>

        <!-- Lagged Analysis -->
        <div class="stats-section">
            <h2>Day-to-Day Relationships</h2>
            <div id="lagged-analysis" class="analysis-results"></div>
        </div>

        <!-- Data Download Section -->
        <div class="stats-section">
            <h2>Data Export</h2>
            <div class="download-section">
                <p>Download your complete health data for backup or analysis:</p>
                <div class="download-buttons">
                    <div class="download-button-group">
                        <button id="download-csv" class="download-btn">
                            üìä Download CSV
                        </button>
                        <small class="filename">health_data_YYYY-MM-DD.csv</small>
                    </div>

                    <div class="download-button-group">
                        <button id="download-json" class="download-btn">
                            üìÅ Download JSON
                        </button>
                        <small class="filename">health_data_YYYY-MM-DD.json</small>
                    </div>

                    <div class="download-button-group">
                        <button id="download-dictionary" class="download-btn">
                            üìñ Metadata Dictionary
                        </button>
                        <small class="filename">health_data_dictionary.json</small>
                    </div>
                </div>
                <p class="download-note">
                    CSV is recommended for analysis in R or pandas. JSON preserves all data structure. The metadata dictionary describes all fields, including the meaning of encoded values.
                </p>
            </div>
        </div>

    </div>

    <script src="settings.js"></script>
    <script src="user-manager.js"></script>
    <script src="common.js"></script>
    <script src="form-config.js"></script>
    <script>
        let chart = null;

        // Available metrics with colors - updated to match backend
        const metricConfig = {
            mood: { label: 'Mood', color: 'rgb(75, 192, 192)', borderDash: [] },
            pain: { label: 'Pain', color: 'rgb(255, 99, 132)', borderDash: [] },
            sexual_wellbeing: { label: 'Sexual Wellbeing', color: 'rgb(255, 159, 64)', borderDash: [] },
            energy: { label: 'Energy', color: 'rgb(54, 162, 235)', borderDash: [5, 5] },
            sleep_quality: { label: 'Sleep Quality', color: 'rgb(153, 102, 255)', borderDash: [10, 5] },
            stress_level_work: { label: 'Work Stress', color: 'rgb(201, 203, 207)', borderDash: [2, 2] },
            stress_level_home: { label: 'Home Stress', color: 'rgb(255, 205, 86)', borderDash: [2, 2] }
        };

        async function loadChartData(days = 30) {
            try {
                // Get selected metrics
                const selectedMetrics = Object.keys(metricConfig).filter(metric => {
                    return document.getElementById(`${metric}-check`)?.checked;
                });

                const response = await fetch(
                    `${SETTINGS.API_BASE_URL}/stats/metrics-over-time?days=${days}&metrics=${selectedMetrics.join(',')}&uid=${userManager.getUID()}`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch stats data');
                }

                return await response.json();
            } catch (error) {
                console.error('Error loading chart data:', error);
                // Fallback to localStorage if needed
                return loadFromLocalStorage(days, selectedMetrics);
            }
        }

        function createChart(data) {
            const ctx = document.getElementById('metricsChart').getContext('2d');

            // Destroy existing chart if it exists
            if (chart) {
                chart.destroy();
            }

            const datasets = [];

            // Create dataset for each selected metric
            Object.keys(data.metrics).forEach(metric => {
                if (data.metrics[metric].some(val => val !== null)) { // Only add if there's data
                    const config = metricConfig[metric];
                    datasets.push({
                        label: config.label,
                        data: data.metrics[metric],
                        borderColor: config.color,
                        backgroundColor: config.color + '20',
                        borderWidth: 2,
                        borderDash: config.borderDash,
                        tension: 0.4, // Smooth lines
                        spanGaps: true, // Connect across missing data
                        pointBackgroundColor: config.color,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }
            });

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric'
                        });
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: 400,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            title: {
                                display: true,
                                text: 'Score (0-10)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        async function updateChart() {
            const days = parseInt(document.getElementById('days-range').value);
            const data = await loadChartData(days);
            createChart(data);
        }

        // Fallback to localStorage data
        function loadFromLocalStorage(days, metrics) {
            const existingData = JSON.parse(localStorage.getItem('healthData') || '[]');
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);

            const filteredData = existingData.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate >= startDate && entryDate <= endDate;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));

            const result = {
                dates: filteredData.map(entry => entry.date),
                metrics: {}
            };

            metrics.forEach(metric => {
                result.metrics[metric] = filteredData.map(entry => entry[metric] || null);
            });

            return result;
        }

        async function loadSummaryStats() {
            try {
                const response = await fetch(`${SETTINGS.API_BASE_URL}/stats/summary?uid=${userManager.getUID()}`);
                const data = await response.json();
                displaySummaryStats(data);
            } catch (error) {
                console.error('Error loading summary stats:', error);
                showErrorBanner('Failed to load statistics');
            }
        }

        function displaySummaryStats(data) {
            const container = document.getElementById('summary-stats');

            container.innerHTML = `
                <div class="stat-card">
                    <h3>${data.total_entries}</h3>
                    <p>Total Entries</p>
                </div>
                <div class="stat-card">
                    <h3>${data.averages.mood}</h3>
                    <p>Average Mood</p>
                </div>
                <div class="stat-card">
                    <h3>${data.averages.pain}</h3>
                    <p>Average Pain</p>
                </div>
                <div class="stat-card">
                    <h3>${data.averages.energy || 'N/A'}</h3>
                    <p>Average Energy</p>
                </div>
                <div class="stat-card">
                    <h3>${data.current_streak ? data.current_streak.length : 0}</h3>
                    <p>Current Streak</p>
                </div>
            `;
        }

        async function loadWeekdayAverages() {
            try {
                const response = await fetch(`${SETTINGS.API_BASE_URL}/stats/weekday-averages?uid=${userManager.getUID()}`);
                const data = await response.json();
                createWeekdayChart(data);
            } catch (error) {
                console.error('Error loading weekday averages:', error);
            }
        }

        function createWeekdayChart(data) {
            const ctx = document.getElementById('weekdayChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.weekday),
                    datasets: [
                        {
                            label: 'Average Mood',
                            data: data.map(d => d.avg_mood),
                            backgroundColor: 'rgba(75, 192, 192, 0.6)'
                        },
                        {
                            label: 'Average Pain',
                            data: data.map(d => d.avg_pain),
                            backgroundColor: 'rgba(255, 99, 132, 0.6)'
                        },
                        {
                            label: 'Average Energy',
                            data: data.map(d => d.avg_energy),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }

        async function loadCorrelations() {
            try {
                const response = await fetch(`${SETTINGS.API_BASE_URL}/stats/correlations?uid=${userManager.getUID()}`);
                const data = await response.json();
                //console.log('Correlations response:', data);
                displayCorrelations(data);
            } catch (error) {
                console.error('Error loading correlations:', error);
            }
        }

        function displayCorrelations(correlations) {
            const container = document.getElementById('correlation-matrix');

            // Check if we got an error object instead of an array
            if (!Array.isArray(correlations)) {
                if (correlations.error) {
                    container.innerHTML = `<p style="text-align: center; color: #666; font-style: italic;">${correlations.error}</p>`;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No correlation data available</p>';
                }
                return;
            }

            // Check if we have any correlations to display
            if (correlations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No correlations found (insufficient data)</p>';
                return;
            }

            // Show top 10 strongest correlations
            const topCorrelations = correlations.slice(0, 10);

            container.innerHTML = topCorrelations.map(corr => `
                <div class="correlation-item">
                    <span class="metric-pair">${corr.metric1} ‚Üî ${corr.metric2}</span>
                    <span class="correlation-value ${corr.correlation > 0 ? 'positive' : 'negative'}">
                        ${corr.correlation}
                    </span>
                    <small>(${corr.sample_size} samples)</small>
                </div>
            `).join('');
        }

        async function loadLaggedAnalysis() {
            try {
                const response = await fetch(`${SETTINGS.API_BASE_URL}/stats/lagged-correlations?uid=${userManager.getUID()}`);
                const data = await response.json();
                displayLaggedAnalysis(data);
            } catch (error) {
                console.error('Error loading lagged analysis:', error);
            }
        }

        function displayLaggedAnalysis(data) {
            const container = document.getElementById('lagged-analysis');

            if (data.error) {
                container.innerHTML = `<p>${data.error}</p>`;
                return;
            }

            container.innerHTML = `
                <div class="lagged-results">
                    <p><strong>Pain today vs Mood tomorrow:</strong> ${data.pain_today_vs_mood_tomorrow}</p>
                    <p><strong>Mood today vs Pain tomorrow:</strong> ${data.mood_today_vs_pain_tomorrow}</p>
                    <p><strong>Sexual Wellbeing today vs Mood tomorrow:</strong> ${data.sexual_wellbeing_today_vs_mood_tomorrow}</p>
                    <p><strong>Pain today vs Energy tomorrow:</strong> ${data.pain_today_vs_energy_tomorrow}</p>
                    <p><strong>Sleep Quality today vs Mood tomorrow:</strong> ${data.sleep_quality_today_vs_mood_tomorrow}</p>
                    <p><strong>Work Stress today vs Mood tomorrow:</strong> ${data.work_stress_today_vs_mood_tomorrow}</p>
                    <p><strong>Home Stress today vs Mood tomorrow:</strong> ${data.home_stress_today_vs_mood_tomorrow}</p>
                    <p><em>Based on ${data.pair_count} day pairs</em></p>
                </div>
            `;
        }

        // Update your existing load function to include all analytics
        async function loadAllAnalytics() {
            try {
            await updateChart(); // Your existing function
            await loadSummaryStats();
            await loadWeekdayAverages();
            await loadCorrelations();
            await loadLaggedAnalysis();
            } catch (error) {
                console.error('Error loading analytics:', error);
                showErrorBanner('Failed to load analytics data');
            }
        }

        // Event listeners
        document.getElementById('update-chart').addEventListener('click', updateChart);
        document.getElementById('days-range').addEventListener('change', updateChart);

        // Initialize chart on page load
        window.addEventListener('load', loadAllAnalytics);

        // Data download functionality
        document.getElementById('download-csv').addEventListener('click', async function() {
            await downloadData('csv');
        });

        document.getElementById('download-json').addEventListener('click', async function() {
            await downloadData('json');
        });

        async function downloadData(format) {
            try {
                const response = await fetch(`${SETTINGS.API_BASE_URL}/export/${format}`);

                if (!response.ok) {
                    throw new Error(`Failed to download ${format.toUpperCase()}`);
                }

                // Create download link
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // Get filename from Content-Disposition header or generate one
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `health_data_export.${format}`;

                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error(`Error downloading ${format.toUpperCase()}:`, error);
                alert(`Failed to download ${format.toUpperCase()} file: ${error.message}`);
            }
        }

        // Data dictionary generation
        function generateDataDictionary() {
            const dictionary = {};

            Object.entries(FORM_CONFIG).forEach(([fieldName, config]) => {
                dictionary[fieldName] = {
                    label: config.label,
                    type: config.type,
                    description: config.scaleLabels ? config.scaleLabels.join(' | ') : null
                };

                // Add value mappings for radio/select fields
                if (config.options) {
                    dictionary[fieldName].value_mappings = config.options;
                }

                // Add encoding info for radio fields with encoding
                if (config.encoding) {
                    dictionary[fieldName].encoding = config.encoding;
                }

                // Add checkbox group structure
                if (config.type === 'checkbox-group' && config.categories) {
                    dictionary[fieldName].categories = config.categories;
                }
            });
            console.log("Generated Data Dictionary:", dictionary);
            return dictionary;
        }

        // Add event listener for the dictionary download
        document.getElementById('download-dictionary').addEventListener('click', function() {
            console.log("Generating data dictionary...");
            const dictionary = generateDataDictionary();
            const dataStr = JSON.stringify(dictionary, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            console.log("Dictionary:", dictionary);

            const url = window.URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'health_data_dictionary.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });
    </script>
    <footer class="app-footer">
        <div class="footer-content">
            <span>User ID: <span id="footer-userid">loading...</span></span>
            <span>Backend URL: <span id="footer-backend-url">loading...</span></span>
        </div>
    </footer>

</body>
</html>